# pdf_extract_infra
Инфраструктура через fastapi и docker

### Почему Docker
Потому что, грубо говоря, Docker - это маловесная виртуальная машина, которой без разницы (практически), на каком железе запускаться.
Стоит только сказать, что при сборке контейнера важно, на какой (и для какой) архитектуре процессора собирается изначальный образ.
Если это не x86, а ARM - Dockerfile и его сборка будут немного различаться

### Что нужно для работы
Установленный Docker Engine.
Для разных систем Docker Engine устанавливается по-своему, поэтому проще всего не приводить примеры тут, а отправить в гугл, как бы грубо это ни звучало.

### Сборка образа
В Dockerfile есть комментарии, что надо сделать для работы с x86 или ARM

1. Для начала проверяем, работает ли docker engine
```docker info```

2. Переходим в папку с Dockerfile и используем команду для сборки образа
```docker build -t <имя-образа> .```

3. Для запуска контейнера используем команду
```docker run -p <внешний-порт-машины>:<порт-контейнера-внутри> <имя-контейнера>```
Если fastapi внутри контейнера слушает 10000 порт, то этот же порт надо указывать после двоеточия

При специфичных условиях сборки (удалённый хостинг с ARM-процессором, возможности собрать образ на нём нет, а наша машина, на которой можем собрать - x86) команда для сборки будет выглядеть примерно так
```docker buildx build --platform linux/arm64 -t pdf-to-png:arm64 .```
То есть необходимо после флага --platform указать платформу конечной машины

### Какие JSON принимает FastApi?

В файле test_endpoint.py есть пример с отправкой запроса на эндпойнт


POST-запрос на http://<доменное-имя>:<внешний-порт-машины>/process-pdf/

```
data = {
    "url": "https://api.slingacademy.com/v1/sample-data/files/text-and-table.pdf",  # URL должен явно указывать на ссылку с PDF-файлом
    "pages": "1-2"  # подробнее про pages ниже
}
```

1. URL должен явно указывать на файл (заканчиваться на .pdf) (обязательное поле)

2. pages является необязательным полем. Если pages отсутствует в JSON или является NULL - конвертируется весь файл. Принимает следующие диапазоны:
```
"1" - сконвертируется только страница 1
"1-3" - сконвертируются страницы 1-3
"1-3, 5" - страницы 1-3 и 5
"1, 3" - страницы 1 и 3
"1, 3-6" - страницы 1 и 3-6
"1, 3, 5-7" - страницы 1, 3 и 5-7
"1-3, 5-7" - страницы 1-3 и 5-7
"1, Ы" - вернется ошибка о недопустимом диапазоне

При этом, если диапазон указан вне доступных в PDF страниц, в JSON вернётся ошибка.

При успешной конвертации возвращается JSON:

```

```
{
    "status": "success",
    "message": "PDF processed",
    "folder_url": "/pngs/{имя-конвертированной-PDF}"  # здесь важно - я пока не решил, стоит ли сокращать имя конвертированного файла как-либо
}

Для доступа к конвертированным файлам можно сделать обычный GET-запрос в браузере на http://<доменное-имя>:<внешний-порт-машины>/<имя-конверированной-PDF>
(я сделал простенький HTML)
Там же можно скачать ZIP-архив с конвертированными PNG
